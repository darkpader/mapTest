<!-- This program creates an interactive map using Leaflet.js and the Web Speech API. and displays
country and city information with speech synthesis. -->

<!DOCTYPE html>
<html>
  <head>
    <title>Interactive Map with Speech</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }

      .tooltip-style {
        font-size: 14px;
        background: white;
        border: 1px solid gray;
        padding: 4px;
      }

      #voiceSelector {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 6px;
        font-size: 14px;
        border-radius: 4px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <select id="voiceSelector"></select>
    <div id="map"></div>

    <script>
      const map = L.map("map").setView([20, 0], 2);
      map.zoomControl.setPosition("bottomleft"); // Move zoom buttons

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const countryDescriptions = {
        SEN: "Senegal",
        AGO: "Angola",
        CAN: "Canada",
        EGY: "Eygypt",
      };

      const cityDescriptions = [
        {
          name: "London, UK",
          lat: 51.5074,
          lon: -0.1278,
          description:
            "Testing Testing 123",
        },
        {
          name: "Dubai, UAE",
          lat: 25.276987,
          lon: 55.296249,
          description: "Attack, Kenobi",
        },
      ];

      const voiceSelector = document.getElementById("voiceSelector");
      let voices = [];
      let selectedVoice = null;
      let isSpeaking = false;

      function populateVoiceList() {
        voices = speechSynthesis.getVoices();
        voiceSelector.innerHTML = "";

        voices.forEach((voice, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${voice.name} (${voice.lang})${
            voice.default ? " â€” Default" : ""
          }`;
          voiceSelector.appendChild(option);
        });

        const preferredIndex = voices.findIndex((v) => v.lang === "en-GB") || 0;
        voiceSelector.value = preferredIndex;
        selectedVoice = voices[preferredIndex];
      }

      speechSynthesis.onvoiceschanged = populateVoiceList;
      populateVoiceList();

      voiceSelector.addEventListener("change", () => {
        const index = parseInt(voiceSelector.value);
        selectedVoice = voices[index];
      });

      function speak(text) {
        if (!text || !selectedVoice) return;

        if (isSpeaking) {
          speechSynthesis.cancel();
          isSpeaking = false;
        }

        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = selectedVoice;

        utter.onstart = () => {
          isSpeaking = true;
        };
        utter.onend = () => {
          isSpeaking = false;
        };
        utter.onerror = () => {
          isSpeaking = false;
        };

        speechSynthesis.speak(utter);
      }

      fetch(
        "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
      )
        .then((res) => res.json())
        .then((data) => {
          L.geoJSON(data, {
            style: (feature) => ({
              fillColor: countryDescriptions[feature.id] ? "#3498db" : "#ccc",
              weight: 1,
              color: "#fff",
              fillOpacity: countryDescriptions[feature.id] ? 0.5 : 0.1,
            }),
            onEachFeature: (feature, layer) => {
              const iso = feature.id;
              const desc = countryDescriptions[iso];

              if (desc) {
                layer.bindTooltip(
                  `<strong>${feature.properties.name}</strong><br>${desc}`,
                  {
                    sticky: true,
                    className: "tooltip-style",
                  }
                );

                layer.on("mouseover", () => {
                  layer.setStyle({ fillOpacity: 0.8 });
                  speak(desc);
                });

                layer.on("mouseout", () => {
                  layer.setStyle({ fillOpacity: 0.5 });
                  speechSynthesis.cancel();
                  isSpeaking = false;
                });
              }
            },
          }).addTo(map);

          cityDescriptions.forEach((city) => {
            const marker = L.circleMarker([city.lat, city.lon], {
              radius: 6,
              fillColor: "#e67e22",
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.9,
            }).addTo(map);

            marker.bindTooltip(
              `<strong>${city.name}</strong><br>${city.description}`,
              {
                sticky: true,
                className: "tooltip-style",
              }
            );

            marker.on("mouseover", () => speak(city.description));
            marker.on("mouseout", () => {
              speechSynthesis.cancel();
              isSpeaking = false;
            });
          });
        })
        .catch((err) => {
          console.error("Error loading GeoJSON:", err);
          alert("Could not load map data.");
        });
    </script>
  </body>
</html>
